#jinja2: trim_blocks: False

{%- set rds_instance_name = vpc + "-openregister-db" -%}
{%- set password_store_key = vpc + "/rds/openregister/" + item.key -%}
{%- set db_name = item.key -%}
{%- set db_user = item.key + "_openregister" -%}
{%- set db_password = lookup("pass", "{{ vpc }}/rds/openregister/" + item.key).decode('utf-8') -%}

{%- set db_host = groups[rds_instance_name][0] -%}
database:
  driverClass: org.postgresql.Driver
  url: jdbc:postgresql://{{ db_host }}:{{ db_port | default(5432) }}/{{ db_name }}
  user: {{ db_user }}
  password: {{ db_password }}

  #db connection properties
  initialSize: {{ db_initial_size | default(1) }}
  minSize: {{ db_min_size | default(1) }}
  maxSize: {{ db_max_size | default(4) }}

  properties:
    charSet: UTF-8

{% for reg in item.value -%}
{%- set register_name = reg -%}
{%- set app_user = "openregister" -%}
{%- set app_password = lookup("pass", "{{ vpc }}/app/mint/" + reg).decode('utf-8') -%}
{%- set settings = register_settings[reg] | default({}) -%}
{%- set default_field_register_url = "https://field." + vpc + ".openregister.org/records.yaml?page-size=5000"  -%}
{%- set default_register_register_url = "https://register." + vpc + ".openregister.org/records.yaml?page-size=5000"  -%}

{%- if loop.first -%}
trackingId: {{ tracking_id }}
register: {{ register_name }}
schema: {{ register_name }}
{% if settings.custodian_name is defined %}custodianName: {{ settings.custodian_name }}{% endif %}
enableDownloadResource: {{ settings.enable_download_resource | default(true) }}
enableRegisterDataDelete: {{ settings.enable_register_data_delete | default(enable_register_data_delete) | default(false) }}

fieldsYamlLocation: {{ settings.fields_yaml_location | default(default_field_register_url) }}
registersYamlLocation: {{ settings.registers_yaml_location | default(default_register_register_url) }}

{% if settings.history_page_url is defined %}historyPageUrl: {{ settings.history_page_url }}{% endif %}
{% if settings.indexes is defined %}indexes:
  {% for index in settings.indexes -%}
    - {{ index }}
  {% endfor %}
{% endif %}
{% if settings.similar_registers is defined %}similarRegisters:
  {% for register in settings.similar_registers -%}
    - {{ register }}
  {% endfor %}
{% endif %}

registerDomain: {{ register_domain }}
externalConfigDirectory: /srv/openregister-java
downloadConfigs: true

server:
  registerDefaultExceptionMappers: false

credentials:
  user: {{ app_user }}
  password: {{ app_password }}

# Logging settings.
logging:
  level: WARN
  appenders:
    - type: console
      target: stdout
      logFormat: "%-5p [%d{ISO8601}] [Register: %X{register}] %c: %m %replace(%rEx){'\n',' '}%nopex%n"

metrics:
  reporters:
    - type: graphite
      host: telegraf
      port: 8092
      transport: udp
      frequency: 5 seconds

{% if loop.length > 1 %}
registers:
{% endif %}
{% else %}
  {{ reg }}:
    trackingId: {{ tracking_id }}
    schema: {{ register_name }}
    {% if settings.custodian_name is defined %}custodianName: {{ settings.custodian_name }}{% endif %}
    enableDownloadResource: {{ settings.enable_download_resource | default(true) }}
    enableRegisterDataDelete: {{ settings.enable_register_data_delete | default(enable_register_data_delete) | default(false) }}
    {% if settings.history_page_url is defined %}historyPageUrl: {{ settings.history_page_url }}{% endif %}
    {% if settings.indexes is defined %}indexes:
      {% for index in settings.indexes -%}
        - {{ index }}
      {% endfor %}
    {% endif %}
    {% if settings.similar_registers is defined %}similarRegisters:
      {% for register in settings.similar_registers -%}
        - {{ register }}
      {% endfor %}
    {% endif %}

    credentials:
      user: {{ app_user }}
      password: {{ app_password }}

{% endif %}
{% endfor %}
